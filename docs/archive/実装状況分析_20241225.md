# PRD実装状況分析レポート

作成日: 2024-12-25

## 概要

PRD（Product Requirements Document）v1.3に基づき、実装済み機能と未実装機能を分析しました。

---

## ✅ 実装済み機能

### 1. 予約管理（4-1）

#### ✅ 予約ステータス管理
- **実装済み**: `pending`, `pending_payment`, `confirmed`, `working`, `completed`, `cancelled`
- **実装場所**: `src/app/api/bookings/[id]/route.ts` (VALID_TRANSITIONS)
- **ステータス遷移検証**: 実装済み

#### ✅ 空き枠計算ロジック（キャパシティベース）
- **実装済み**: `max_capacity` ベースの空き枠計算
- **実装場所**: 
  - `src/lib/booking-core.ts` (calculateAvailabilityCore)
  - `src/app/api/availability-v2/route.ts`
- **機能**: 店舗全体のキャパシティから既存予約数を引いて残り枠数を計算

#### ✅ 決済待ち（pending_payment）のTTL管理
- **実装済み**: 15分間の有効期限（`expires_at`）
- **実装場所**: 
  - `src/app/api/bookings/route.ts` (予約作成時に設定)
  - `src/app/api/webhooks/stripe/route.ts` (Webhook受信時に検証)
  - `src/app/api/cron/cleanup-payments/route.ts` (定期クリーンアップ)
- **機能**: 期限切れの自動キャンセル処理

#### ✅ キャンセル・返金ポリシー
- **実装済み**: 段階的キャンセル料計算
- **実装場所**: `src/lib/pricing.ts` (calculateCancellationFee)
- **ポリシー**:
  - 48時間前まで: 無料
  - 24-48時間前: 30%
  - 24時間以内: 50%
  - 当日: 100%
- **返金処理**: Stripe Refund API連携済み

#### ✅ 予約チャネル管理
- **実装済み**: `web`, `line`, `phone`, `walk_in`
- **実装場所**: `src/types/index.ts` (BookingChannel型定義)

### 2. 顧客管理（4-2）

#### ✅ 顧客台帳・履歴管理
- **実装済み**: 顧客一覧、詳細、予約履歴表示
- **実装場所**: 
  - `src/app/admin/customers/page.tsx`
  - `src/app/api/customers/route.ts`
- **機能**: 店舗単位での顧客管理、累計利用回数・LTV計算

#### ⚠️ 家カルテ（住宅設備管理）
- **部分実装**: スキーマ・UIコンポーネントは存在
- **実装場所**: 
  - `src/components/features/customers/HouseAssetCard.tsx`
  - `src/lib/asset-logic.ts`
- **未実装**: プッシュ提案機能（Phase 2予定）

### 3. 通知・コミュニケーション（4-4）

#### ✅ 予約確定通知
- **実装済み**: LINE通知（Growth+プラン）
- **実装場所**: 
  - `src/lib/line/notifications.ts` (sendBookingConfirmationLine)
  - `src/app/api/bookings/route.ts` (現地決済時)
  - `src/app/api/webhooks/stripe/route.ts` (オンライン決済完了時)

#### ✅ 予約キャンセル通知
- **実装済み**: LINE通知
- **実装場所**: `src/lib/line/notifications.ts` (sendBookingCancelledLine)

#### ✅ レビュー依頼通知
- **実装済み**: 施工完了後のレビュー依頼
- **実装場所**: `src/app/api/cron/reviews/route.ts`

#### ❌ 前日リマインド通知
- **未実装**: 前日リマインドの自動送信機能
- **PRD要件**: 必須（Section 4-4-B）
- **実装場所**: 未実装（Cronジョブが必要）

#### ❌ 当日「向かっています」通知
- **未実装**: スタッフ出発通知
- **PRD要件**: 任意（Section 4-4-B）
- **実装場所**: 未実装（スタッフアプリ連携が必要）

#### ❌ スタッフ向け通知
- **未実装**: 新規予約割り当て、予約変更、当日スケジュール通知
- **PRD要件**: Section 4-4-C
- **実装場所**: 未実装（Push通知機能が必要）

### 4. マルチテナント管理（4-3）

#### ✅ 階層構造
- **実装済み**: Organizations → Stores → Profiles
- **実装場所**: データベーススキーマ、RLSポリシー

#### ✅ セキュリティルール（RLS）
- **実装済み**: 組織間データ分離、店舗内限定アクセス
- **実装場所**: Supabase RLSポリシー

### 5. 料金プラン・機能制限（6）

#### ✅ プラン体系
- **実装済み**: Starter, Growth, Enterprise
- **実装場所**: 
  - `src/lib/plan/access.ts`
  - `src/app/api/admin/plan/usage/route.ts`
  - `src/app/api/admin/plan/change/route.ts`

#### ✅ リソース制限
- **実装済み**: 店舗数、スタッフ数、家カルテ登録数の制限
- **実装場所**: 
  - `src/lib/plan/access.ts` (checkResourceLimit)
  - データベーストリガー（`check_resource_limit`）

#### ✅ 機能制限
- **実装済み**: LINE通知、Googleカレンダー同期のプラン別制御
- **実装場所**: `src/lib/plan/access.ts` (getPlanAccess)

### 6. 権限管理（7）

#### ✅ ロール定義
- **実装済み**: `hq_admin`, `store_admin`, `field_staff`
- **実装場所**: データベーススキーマ、RLSポリシー

#### ✅ 認証ミドルウェア
- **実装済み**: `withAuth`, `withPublic`
- **実装場所**: `src/lib/api/middleware.ts`

### 7. 分析ダッシュボード（8）

#### ✅ 基本分析
- **実装済み**: 売上推移、チャネル別分析、店舗別パフォーマンス
- **実装場所**: `src/app/admin/analytics/page.tsx`

#### ⚠️ 詳細分析
- **部分実装**: 基本指標は実装済み
- **未実装**: 
  - スタッフ別売上比較
  - メニュー別売上分析
  - LTV分析（本部向け）
  - Retention / Churn分析

### 8. 画面実装（10-2）

#### ✅ 公開画面（顧客向け）
- **実装済み**: 
  - `/` (ルート予約ページ)
  - `/book/:org_slug/:store_slug` (特定店舗予約ページ)
  - `/reviews/:bookingId` (レビュー投稿)
  - `/login` (ログイン)

#### ✅ 管理画面（店舗管理者）
- **実装済み**: 
  - `/admin` (ダッシュボード)
  - `/admin/bookings` (予約一覧)
  - `/admin/calendar` (予約カレンダー)
  - `/admin/services` (サービス管理)
  - `/admin/staff` (スタッフ管理)
  - `/admin/customers` (顧客一覧)
  - `/admin/analytics` (分析ダッシュボード)
  - `/admin/settings` (店舗設定)
  - `/admin/stores` (店舗一覧)
  - `/admin/errors` (エラーログ)

#### ✅ 本部画面（Super Admin）
- **実装済み**: 
  - `/hq` (本部ダッシュボード)
  - `/hq/billing` (請求管理)

### 9. 外部連携

#### ✅ Stripe決済
- **実装済み**: オンライン決済、返金処理、Webhook処理
- **実装場所**: 
  - `src/app/api/checkout/session/route.ts`
  - `src/app/api/webhooks/stripe/route.ts`

#### ✅ Googleカレンダー同期
- **実装済み**: 予約確定時のカレンダー同期（Growth+プラン）
- **実装場所**: `src/lib/google/sync.ts`

#### ✅ LINE通知
- **実装済み**: 予約確定、キャンセル、レビュー依頼通知（Growth+プラン）
- **実装場所**: `src/lib/line/notifications.ts`

### 10. その他

#### ✅ ブランディング・デザインカスタマイズ
- **実装済み**: メインカラー、アクセントカラー、ウェルカムメッセージ
- **実装場所**: `src/app/admin/stores/[id]/branding/page.tsx`

#### ✅ 監査ログ
- **実装済み**: 予約作成・更新・キャンセルのログ記録
- **実装場所**: `src/lib/audit-log.ts`

#### ✅ レビュー機能
- **実装済み**: レビュー投稿、表示
- **実装場所**: `src/app/reviews/[bookingId]/page.tsx`

---

## ❌ 未実装機能

### 1. 通知機能（4-4）

#### ❌ 前日リマインド通知
- **PRD要件**: 必須（Section 4-4-B）
- **実装方法**: Cronジョブで前日の予約を検索し、LINE/メール通知
- **優先度**: 高

#### ❌ 当日「向かっています」通知
- **PRD要件**: 任意（Section 4-4-B）
- **実装方法**: スタッフアプリから出発ボタン押下時に通知
- **優先度**: 中

#### ❌ スタッフ向け通知
- **PRD要件**: Section 4-4-C
- **実装方法**: Push通知機能の実装が必要
- **優先度**: 中

#### ❌ メール通知
- **PRD要件**: LINE未連携時のフォールバック
- **実装方法**: メール送信サービス（SendGrid等）の統合
- **優先度**: 中

### 2. スマート着信対応（4-5）

#### ❌ Phase 1.2: スマートSMS自動返信
- **PRD要件**: Phase 1.2
- **実装方法**: Twilio/SMSAPI統合、不在着信検知
- **優先度**: 中

#### ❌ Phase 1.2: 不在着信ダッシュボード
- **PRD要件**: Phase 1.2
- **実装方法**: 管理画面に不在着信リスト表示
- **優先度**: 中

#### ❌ Phase 2.0: AI電話応答エージェント
- **PRD要件**: Phase 2.0（将来機能）
- **実装方法**: Twilio Flex + OpenAI Realtime Voice API
- **優先度**: 低（Phase 2）

### 3. 家カルテ機能（4-2-C）

#### ❌ プッシュ提案機能
- **PRD要件**: Phase 2（将来機能）
- **実装方法**: 設置時期からの経過年数に基づく自動提案
- **優先度**: 低（Phase 2）

### 4. 分析機能（8）

#### ❌ スタッフ別売上比較
- **PRD要件**: Section 8-1
- **実装方法**: 分析ダッシュボードに追加
- **優先度**: 中

#### ❌ メニュー別売上分析
- **PRD要件**: Section 8-1
- **実装方法**: 分析ダッシュボードに追加
- **優先度**: 中

#### ❌ 本部向け横断分析
- **PRD要件**: Section 8-2
- **実装方法**: `/hq/analytics` ページの拡張
- **優先度**: 中

#### ❌ LTV分析
- **PRD要件**: Section 8-2
- **実装方法**: 顧客の累計支出額を計算・可視化
- **優先度**: 中

#### ❌ Retention / Churn分析
- **PRD要件**: Section 8-2
- **実装方法**: 定期サービスの継続率・離脱時期の分析
- **優先度**: 低

### 5. 請求・精算（5-2）

#### ❌ 月次請求管理
- **PRD要件**: Section 5-2
- **実装方法**: Stripe Connect統合、請求書自動生成
- **優先度**: 高（Phase 1.2）

#### ❌ 請求書発行
- **PRD要件**: Section 5-2
- **実装方法**: PDF生成、メール送信
- **優先度**: 高（Phase 1.2）

### 6. その他

#### ❌ オフライン対応・PWA（20）
- **PRD要件**: Phase 1.1（基本対応）
- **実装方法**: Service Worker、IndexedDB、オフライン同期
- **優先度**: 中

#### ❌ アクセシビリティ（21-1）
- **PRD要件**: WCAG 2.1 AA準拠目標
- **実装方法**: ARIAラベル、キーボード操作、コントラスト比改善
- **優先度**: 中

#### ❌ 国際化（21-2）
- **PRD要件**: Phase 3（将来機能）
- **実装方法**: next-intl統合
- **優先度**: 低（Phase 3）

---

## 📊 実装状況サマリー

### 実装率（Phase 1.1対象機能）

| カテゴリ | 実装済み | 未実装 | 実装率 |
|:---|:---:|:---:|:---:|
| **予約管理** | 6 | 0 | 100% |
| **顧客管理** | 2 | 1 | 67% |
| **通知機能** | 3 | 4 | 43% |
| **マルチテナント** | 2 | 0 | 100% |
| **料金プラン** | 3 | 0 | 100% |
| **権限管理** | 2 | 0 | 100% |
| **分析ダッシュボード** | 1 | 4 | 20% |
| **画面実装** | 14 | 0 | 100% |
| **外部連携** | 3 | 0 | 100% |
| **その他** | 3 | 3 | 50% |

### 全体実装率: **約75%**（Phase 1.1対象機能）

---

## 🎯 優先度別未実装機能

### 優先度: 高（Phase 1.1完了に必要）

1. **前日リマインド通知**（必須）
   - 実装工数: 2-3日
   - 依存: Cronジョブ設定

2. **月次請求管理**（Phase 1.2）
   - 実装工数: 1-2週間
   - 依存: Stripe Connect統合

### 優先度: 中（Phase 1.2推奨）

3. **スタッフ別・メニュー別売上分析**
   - 実装工数: 3-5日

4. **メール通知フォールバック**
   - 実装工数: 2-3日
   - 依存: メール送信サービス統合

5. **不在着信ダッシュボード**
   - 実装工数: 3-5日

6. **オフライン対応（基本）**
   - 実装工数: 1-2週間

### 優先度: 低（Phase 2以降）

7. **AI電話応答エージェント**
8. **家カルテプッシュ提案**
9. **国際化対応**

---

## 📝 備考

- **Phase 1.1完了定義**: PRD Section 11参照
  - 5店舗×スタッフ10名規模での7日間連続無障害運用
  - 予約・空き枠計算API応答時間 P95 < 200ms
  - 決済成功率 > 99%

- **v1.3実装済み機能**: PRD Section 11参照
  - 白黒デザイン、ルートパス予約ページ、管理画面日本語化等

- **技術的負債**: 一部機能は実装されているが、最適化が必要な箇所あり

---

## 結論

**Phase 1.1のコア機能は概ね実装済み**ですが、**通知機能の一部（前日リマインド）が未実装**です。Phase 1.1完了のためには、前日リマインド通知の実装が推奨されます。

Phase 1.2に向けては、請求管理機能と詳細分析機能の実装が重要です。


