# 技術負債対策実装報告

> 実装日: 2024-12-24  
> 方針: 既存コードを「壊さずに」改善、将来の技術負債を増やさない

---

## ✅ 実装完了項目

### タスク1: 予約・料金ロジックの集約

**実装内容**:
- `src/lib/booking-core.ts` を作成
- 予約作成、料金計算、所要時間計算を1ファイルに集約
- `createBookingCore()` と `calculateAvailabilityCore()` を提供

**変更ファイル**:
- `src/lib/booking-core.ts` (新規)

**技術負債対策**:
- ✅ ロジックを1箇所に集約することで、将来の変更時の影響範囲を明確化
- ✅ UIやAPIルートから切り離すことで、ビジネスロジックの再利用性を向上
- ✅ 処理が多少汚くても構わないが、分散させないことを優先

**既存コードへの影響**:
- なし（新規ファイルのみ、既存コードは変更していない）

---

### タスク2: 最低限のログ追加

**実装内容**:
- 空き枠計算の入力値・結果をログ記録
- 予約作成の開始・成功・失敗をログ記録
- 構造化ログ（`logger`, `loggers`）を使用

**変更ファイル**:
- `src/lib/booking-core.ts` (ログ追加)

**技術負債対策**:
- ✅ 後から原因調査が可能な粒度でログを記録
- ✅ 構造化ログにより、検索・分析が容易

**ログ出力箇所**:
- 空き枠計算: 入力値（storeSlug, date, cartItems）、結果（availableSlotsCount, existingBookings）
- 予約作成: 開始、料金計算結果、成功/失敗

---

### タスク3: 外部連携の安全化

**実装内容**:
- LINE通知を try/catch で囲み、失敗しても予約作成は成功扱い
- Google Calendar連携を try/catch で囲み、失敗しても予約作成は成功扱い
- Stripe Webhook内の外部連携も同様に安全化

**変更ファイル**:
- `src/app/api/bookings/route.ts` (LINE/Google Calendar連携の安全化)
- `src/app/api/webhooks/stripe/route.ts` (Webhook内の外部連携の安全化)

**技術負債対策**:
- ✅ 外部連携の失敗が予約・決済の本体処理を阻害しない
- ✅ 失敗時はログのみ残し、予約は成功扱いで続行
- ✅ 不可侵領域「外部連携が落ちても本体が止まらない」を確保

**既存コードへの影響**:
- 最小限（try/catchの追加のみ、既存の処理フローは変更なし）

---

### タスク4: enum増殖を防ぐ逃げ道

**実装内容**:
- `bookings`, `customers`, `stores` テーブルに `metadata (JSONB)` カラムを追加
- GINインデックスを追加して検索性能を確保

**変更ファイル**:
- `supabase/migrations/20241225_metadata_and_soft_delete.sql` (新規)

**技術負債対策**:
- ✅ 将来の例外対応は enum を増やさず metadata で吸収可能
- ✅ スキーマ変更なしで柔軟な拡張が可能
- ✅ 例: `{ "special_request": "エレベーター使用不可", "custom_status": "..." }`

**マイグレーション実行**:
```bash
# Supabase CLIで実行
supabase migration up
```

**既存コードへの影響**:
- なし（新規カラム追加のみ、既存のクエリは影響なし）

---

### タスク5: 削除は論理削除に統一

**実装内容**:
- `bookings`, `customers`, `stores`, `services`, `staff` テーブルに `deleted_at` カラムを追加
- 部分インデックス（`WHERE deleted_at IS NULL`）を追加して性能を確保

**変更ファイル**:
- `supabase/migrations/20241225_metadata_and_soft_delete.sql` (新規)

**技術負債対策**:
- ✅ 物理削除を避け、データの完全性と監査証跡を保持
- ✅ 誤削除時の復旧が容易
- ✅ 統計・分析用のデータが失われない

**注意事項**:
- RLSポリシーへの `deleted_at IS NULL` 条件の追加は、既存ポリシーを壊さないよう個別に実施が必要
- 既存の削除処理は後で論理削除に置き換える必要がある（今回はスキーマ準備のみ）

**既存コードへの影響**:
- なし（新規カラム追加のみ、既存のクエリは影響なし）

---

### タスク6: 最低限のテスト追加

**実装内容**:
- `src/lib/booking-core.test.ts` を作成
- 3ケースのみ実装:
  1. 通常の予約が作成できる
  2. 料金計算が正しい
  3. 空き枠が1件以上返る

**変更ファイル**:
- `src/lib/booking-core.test.ts` (新規)

**技術負債対策**:
- ✅ ビジネスロジック寄りのテストにより、コア機能の動作を保証
- ✅ 最低限のケースのみで、過度なテストコードによる負債を回避

**テスト実行**:
```bash
npm test -- src/lib/booking-core.test.ts
```

**既存コードへの影響**:
- なし（新規テストファイルのみ）

---

## 📊 実装サマリー

| タスク | 状態 | 変更ファイル数 | 既存コードへの影響 |
|:---|:---:|:---:|:---:|
| タスク1: ロジック集約 | ✅ 完了 | 1 (新規) | なし |
| タスク2: ログ追加 | ✅ 完了 | 1 (修正) | なし |
| タスク3: 外部連携安全化 | ✅ 完了 | 2 (修正) | 最小限 |
| タスク4: metadata追加 | ✅ 完了 | 1 (新規) | なし |
| タスク5: 論理削除 | ✅ 完了 | 1 (新規) | なし |
| タスク6: テスト追加 | ✅ 完了 | 1 (新規) | なし |

---

## 🔒 不可侵領域の確認

以下の不可侵領域は全て維持されています：

1. ✅ **予約が作成できること**: `createBookingCore()` で実装、既存APIは変更なし
2. ✅ **空き枠計算が壊れないこと**: `calculateAvailabilityCore()` で実装、既存ロジックを集約
3. ✅ **金額計算が狂わないこと**: `calculateBookingPrice()` を再利用、既存ロジックを維持
4. ✅ **他社・他店舗のデータが見えないこと**: RLSポリシーは変更なし
5. ✅ **外部連携が落ちても本体が止まらないこと**: try/catchで安全化

---

## 📝 次のステップ（推奨）

### 短期（1-2週間）
1. **マイグレーション実行**: `20241225_metadata_and_soft_delete.sql` を適用
2. **既存APIの段階的移行**: `booking-core.ts` を使用するよう既存APIを更新（任意）

### 中期（1-2ヶ月）
1. **論理削除の実装**: 既存の削除処理を `deleted_at` を使用するよう更新
2. **RLSポリシーの更新**: `deleted_at IS NULL` 条件を追加

### 長期（3-6ヶ月）
1. **metadata活用**: 例外対応で enum ではなく metadata を使用
2. **テストカバレッジ拡大**: 他のビジネスロジックにもテストを追加

---

## 🎯 技術負債対策の効果

### 実現できたこと
- ✅ **ロジックの集約**: 予約・料金計算が1箇所に集約され、変更時の影響範囲が明確
- ✅ **外部連携の分離**: 外部連携の失敗が本体処理を阻害しない
- ✅ **拡張性の確保**: metadataカラムにより、enum増殖を避けられる
- ✅ **データの保護**: 論理削除により、データの完全性を保持

### 将来のメリット
- **変更コストの削減**: ロジックが集約されているため、修正が容易
- **障害の局所化**: 外部連携の失敗が本体に影響しない
- **柔軟な拡張**: metadataにより、スキーマ変更なしで機能追加が可能
- **データの復旧**: 論理削除により、誤削除時の復旧が容易

---

## ⚠️ 注意事項

1. **マイグレーション実行**: `20241225_metadata_and_soft_delete.sql` を本番環境に適用する前に、必ずステージング環境で検証してください。

2. **既存コードの互換性**: 今回の実装は既存コードを壊さないよう配慮していますが、`booking-core.ts` を使用する場合は既存APIの動作確認が必要です。

3. **RLSポリシーの更新**: `deleted_at IS NULL` 条件の追加は、既存のRLSポリシーを個別に更新する必要があります。一括変更は避けてください。

---

© 2024 株式会社Amber. All rights reserved.



