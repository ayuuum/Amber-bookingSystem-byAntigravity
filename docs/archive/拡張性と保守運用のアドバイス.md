# Amber ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼šæ‹¡å¼µæ€§ã¨ä¿å®ˆé‹ç”¨ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹

> ä½œæˆæ—¥: 2024-12-24  
> ç›®çš„: ä»Šå¾Œã®æ‹¡å¼µæ€§ã¨ä¿å®ˆé‹ç”¨ã‚’è€ƒæ…®ã—ãŸæŠ€è¡“çš„æ”¹å–„ææ¡ˆ

---

## ğŸ“‹ ç›®æ¬¡

1. [ç¾çŠ¶åˆ†æ](#ç¾çŠ¶åˆ†æ)
2. [å„ªå…ˆåº¦åˆ¥æ”¹å–„ææ¡ˆ](#å„ªå…ˆåº¦åˆ¥æ”¹å–„ææ¡ˆ)
3. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„)
4. [é‹ç”¨ãƒ»ç›£è¦–ã®å¼·åŒ–](#é‹ç”¨ç›£è¦–ã®å¼·åŒ–)
5. [ãƒ†ã‚¹ãƒˆæˆ¦ç•¥](#ãƒ†ã‚¹ãƒˆæˆ¦ç•¥)
6. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã®æœ€é©åŒ–](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã®æœ€é©åŒ–)
7. [ã‚³ãƒ¼ãƒ‰å“è³ªã®å‘ä¸Š](#ã‚³ãƒ¼ãƒ‰å“è³ªã®å‘ä¸Š)

---

## ç¾çŠ¶åˆ†æ

### âœ… è‰¯ã„ç‚¹

- **ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ä½“ç³»**: PRDã«åŸºã¥ã„ãŸçµ±ä¸€çš„ãªã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ä½“ç³»ãŒå®Ÿè£…æ¸ˆã¿
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: PRDã‚’ä¸­å¿ƒã¨ã—ãŸåŒ…æ‹¬çš„ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½“ç³»
- **å‹å®‰å…¨æ€§**: TypeScriptã«ã‚ˆã‚‹å‹å®šç¾©
- **RLS**: Supabase RLSã«ã‚ˆã‚‹ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢
- **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–**: `src/lib`é…ä¸‹ã«æ©Ÿèƒ½åˆ¥ã«åˆ†å‰²ã•ã‚ŒãŸãƒ­ã‚¸ãƒƒã‚¯

### âš ï¸ æ”¹å–„ãŒå¿…è¦ãªç‚¹

- **ãƒ­ã‚°ãƒ»ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°**: æ§‹é€ åŒ–ãƒ­ã‚°ã‚„APMã®å®Ÿè£…ãŒä¸ååˆ†
- **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒ»E2Eãƒ†ã‚¹ãƒˆãŒã»ã¼å­˜åœ¨ã—ãªã„
- **APIè¨­è¨ˆ**: çµ±ä¸€çš„ãªãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å±¤ãŒä¸è¶³
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: RLSãƒãƒªã‚·ãƒ¼ã®è¤‡é›‘ã•ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã®èª²é¡Œ
- **ç’°å¢ƒå¤‰æ•°**: èµ·å‹•æ™‚ã®æ¤œè¨¼ãŒä¸ååˆ†
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ãƒ­ã‚°å‡ºåŠ›ã®çµ±ä¸€æ€§ãŒä¸æ˜

---

## å„ªå…ˆåº¦åˆ¥æ”¹å–„ææ¡ˆ

### ğŸ”´ é«˜å„ªå…ˆåº¦ï¼ˆå³åº§ã«å¯¾å¿œã™ã¹ãï¼‰

#### 1. æ§‹é€ åŒ–ãƒ­ã‚°ã®å°å…¥

**ç¾çŠ¶**: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒçµ±ä¸€ã•ã‚Œã¦ã„ãªã„ã€æœ¬ç•ªç’°å¢ƒã§ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå›°é›£

**ææ¡ˆ**:
```typescript
// src/lib/logger.ts ã‚’ä½œæˆ
import { createLogger, format, transports } from 'winston';

export const logger = createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: format.combine(
    format.timestamp(),
    format.errors({ stack: true }),
    format.json()
  ),
  defaultMeta: {
    service: 'amber',
    environment: process.env.NODE_ENV,
  },
  transports: [
    new transports.Console({
      format: format.combine(
        format.colorize(),
        format.simple()
      )
    }),
    // æœ¬ç•ªç’°å¢ƒã§ã¯å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆDatadogã€CloudWatchç­‰ï¼‰ã«é€ä¿¡
  ],
});

// ä½¿ç”¨ä¾‹
logger.info('Booking created', { 
  bookingId: booking.id, 
  storeId: store.id,
  userId: user.id 
});
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- æœ¬ç•ªç’°å¢ƒã§ã®å•é¡Œç‰¹å®šãŒå®¹æ˜“
- ã‚¨ãƒ©ãƒ¼è¿½è·¡ã®è‡ªå‹•åŒ–
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æã®åŸºç›¤

---

#### 2. ç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼

**ç¾çŠ¶**: èµ·å‹•æ™‚ã«ç’°å¢ƒå¤‰æ•°ã®ä¸è¶³ã‚’æ¤œçŸ¥ã§ããªã„

**ææ¡ˆ**:
```typescript
// src/lib/env.ts ã‚’ä½œæˆ
import { z } from 'zod';

const envSchema = z.object({
  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
  SUPABASE_SERVICE_ROLE_KEY: z.string().min(1),
  STRIPE_SECRET_KEY: z.string().startsWith('sk_'),
  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: z.string().startsWith('pk_'),
  STRIPE_WEBHOOK_SECRET: z.string().optional(),
  LINE_CHANNEL_ACCESS_TOKEN: z.string().optional(),
  LINE_CHANNEL_SECRET: z.string().optional(),
  NEXT_PUBLIC_APP_URL: z.string().url(),
  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
});

export type Env = z.infer<typeof envSchema>;

export function validateEnv(): Env {
  try {
    return envSchema.parse(process.env);
  } catch (error) {
    if (error instanceof z.ZodError) {
      console.error('âŒ ç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ:');
      error.errors.forEach((err) => {
        console.error(`  - ${err.path.join('.')}: ${err.message}`);
      });
      process.exit(1);
    }
    throw error;
  }
}

// app/layout.tsx ã¾ãŸã¯ middleware.ts ã§èµ·å‹•æ™‚ã«å®Ÿè¡Œ
if (typeof window === 'undefined') {
  validateEnv();
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- èµ·å‹•æ™‚ã®æ—©æœŸã‚¨ãƒ©ãƒ¼æ¤œçŸ¥
- å‹å®‰å…¨ãªç’°å¢ƒå¤‰æ•°ã‚¢ã‚¯ã‚»ã‚¹
- ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æ¤œè¨¼

---

#### 3. API ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®çµ±ä¸€

**ç¾çŠ¶**: å„APIãƒ«ãƒ¼ãƒˆã§èªè¨¼ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé‡è¤‡

**ææ¡ˆ**:
```typescript
// src/lib/api/middleware.ts ã‚’ä½œæˆ
import { NextRequest, NextResponse } from 'next/server';
import { createServerClient } from '@supabase/ssr';
import { errorResponse, AmberErrors } from '@/lib/errors';
import { logger } from '@/lib/logger';

export interface ApiContext {
  user: { id: string; role: string; orgId: string };
  supabase: ReturnType<typeof createServerClient>;
}

export type ApiHandler = (
  request: NextRequest,
  context: ApiContext
) => Promise<NextResponse>;

export function withAuth(handler: ApiHandler) {
  return async (request: NextRequest) => {
    try {
      const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
          cookies: {
            getAll: () => request.cookies.getAll(),
            setAll: () => {}, // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã¯ä¸è¦
          },
        }
      );

      const { data: { user }, error } = await supabase.auth.getUser();

      if (error || !user) {
        return errorResponse(AmberErrors.UNAUTHORIZED());
      }

      // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—
      const { data: profile } = await supabase
        .from('profiles')
        .select('role, organization_id')
        .eq('id', user.id)
        .single();

      if (!profile) {
        return errorResponse(AmberErrors.FORBIDDEN());
      }

      const context: ApiContext = {
        user: {
          id: user.id,
          role: profile.role,
          orgId: profile.organization_id,
        },
        supabase,
      };

      return await handler(request, context);
    } catch (error) {
      logger.error('API handler error', { error, path: request.nextUrl.pathname });
      return errorResponse(AmberErrors.INTERNAL_ERROR());
    }
  };
}

// ä½¿ç”¨ä¾‹: src/app/api/bookings/route.ts
export const GET = withAuth(async (request, context) => {
  // èªè¨¼æ¸ˆã¿ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å‡¦ç†
  const { user, supabase } = context;
  // ...
});
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡å‰Šæ¸›
- ä¸€è²«ã—ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®çµ±ä¸€

---

### ğŸŸ¡ ä¸­å„ªå…ˆåº¦ï¼ˆ3ãƒ¶æœˆä»¥å†…ã«å¯¾å¿œï¼‰

#### 4. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã®ç¢ºç«‹

**ç¾çŠ¶**: ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã»ã¼å­˜åœ¨ã—ãªã„

**ææ¡ˆ**:

**A. ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆVitestï¼‰**
```typescript
// src/lib/booking-logic.test.ts
import { describe, it, expect } from 'vitest';
import { calculateBookingPrice } from './booking-logic';

describe('calculateBookingPrice', () => {
  it('åŸºæœ¬æ–™é‡‘ã‚’è¨ˆç®—ã™ã‚‹', () => {
    const service = { price: 5000, duration_minutes: 60 };
    const result = calculateBookingPrice(service, []);
    expect(result.total).toBe(5000);
  });

  it('ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ–™é‡‘ã‚’åŠ ç®—ã™ã‚‹', () => {
    const service = { price: 5000, duration_minutes: 60 };
    const options = [{ price: 1000 }, { price: 2000 }];
    const result = calculateBookingPrice(service, options);
    expect(result.total).toBe(8000);
  });
});
```

**B. APIçµ±åˆãƒ†ã‚¹ãƒˆ**
```typescript
// src/app/api/bookings/route.test.ts
import { describe, it, expect } from 'vitest';
import { POST } from './route';
import { createMocks } from 'node-mocks-http';

describe('POST /api/bookings', () => {
  it('èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨401ã‚’è¿”ã™', async () => {
    const { req, res } = createMocks({
      method: 'POST',
      body: { serviceId: 'xxx' },
    });
    await POST(req);
    expect(res._getStatusCode()).toBe(401);
  });
});
```

**C. E2Eãƒ†ã‚¹ãƒˆï¼ˆPlaywrightï¼‰**
```typescript
// e2e/booking-flow.spec.ts
import { test, expect } from '@playwright/test';

test('äºˆç´„ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å®Œäº†ã™ã‚‹', async ({ page }) => {
  await page.goto('/book/demo-org/demo-store');
  await page.click('text=ã‚¨ã‚¢ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°');
  await page.click('text=æ¬¡ã¸');
  // ...
  await expect(page.locator('text=äºˆç´„ãŒç¢ºå®šã—ã¾ã—ãŸ')).toBeVisible();
});
```

**ç›®æ¨™ã‚«ãƒãƒ¬ãƒƒã‚¸**:
- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯: 80%ä»¥ä¸Š
- APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: 70%ä»¥ä¸Š
- UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: 60%ä»¥ä¸Š

---

#### 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã®æ”¹å–„

**ç¾çŠ¶**: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤šãã€RLSãƒãƒªã‚·ãƒ¼ãŒè¤‡é›‘

**ææ¡ˆ**:

**A. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•´ç†**
```sql
-- supabase/migrations/YYYYMMDD_description.sql
-- å‘½åè¦å‰‡ã‚’çµ±ä¸€: YYYYMMDD_phase_feature.sql
-- ä¾‹: 20241225_phase1_2_booking_optimization.sql

-- å„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
-- Purpose: äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
-- Related PRD: Section 4-1
-- Breaking Changes: ãªã—
```

**B. RLSãƒãƒªã‚·ãƒ¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–**
```sql
-- supabase/migrations/20241225_rls_policies_documentation.sql
-- RLSãƒãƒªã‚·ãƒ¼ã®ç›®çš„ã¨å‹•ä½œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§æ˜è¨˜

-- Policy: "Bookings View Access"
-- Purpose: çµ„ç¹”å†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªçµ„ç¹”ã®äºˆç´„ã®ã¿é–²è¦§å¯èƒ½
-- Access Pattern: 
--   - Super Admin: å…¨åº—èˆ—ã®äºˆç´„ã‚’é–²è¦§
--   - Store Admin: è‡ªåº—èˆ—ã®äºˆç´„ã‚’é–²è¦§
--   - Staff: è‡ªèº«ãŒæ‹…å½“ã™ã‚‹äºˆç´„ã‚’é–²è¦§
create policy "Bookings View Access" on public.bookings
  for select using (
    organization_id = auth.jwt_org_id() and (
      auth.jwt_role() = 'org_admin' or
      (auth.jwt_role() = 'store_manager' and store_id = auth.jwt_store_id())
    )
  );
```

**C. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**
```typescript
// scripts/verify-migration.ts
// ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå‰å¾Œã§RLSãƒãƒªã‚·ãƒ¼ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹æ¤œè¨¼
```

---

#### 6. APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹ã®çµ±ä¸€

**ç¾çŠ¶**: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‹å®šç¾©ãŒä¸æ˜ç¢º

**ææ¡ˆ**:
```typescript
// src/types/api.ts
export interface ApiResponse<T> {
  data: T;
  error?: never;
}

export interface ApiErrorResponse {
  data?: never;
  error: {
    code: string;
    message: string;
    details?: Record<string, unknown>;
  };
}

export type ApiResult<T> = ApiResponse<T> | ApiErrorResponse;

// ä½¿ç”¨ä¾‹
export async function getBookings(): Promise<ApiResult<Booking[]>> {
  try {
    const bookings = await fetchBookings();
    return { data: bookings };
  } catch (error) {
    return { error: { code: 'ERR_BOOK_001', message: '...' } };
  }
}
```

---

### ğŸŸ¢ ä½å„ªå…ˆåº¦ï¼ˆ6ãƒ¶æœˆä»¥å†…ã«å¯¾å¿œï¼‰

#### 7. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆã®å®Ÿè£…

**ææ¡ˆ**:

**A. APMï¼ˆApplication Performance Monitoringï¼‰**
- Vercel Analytics ã¾ãŸã¯ Datadog ã‚’å°å…¥
- APIå¿œç­”æ™‚é–“ã€ã‚¨ãƒ©ãƒ¼ç‡ã€ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã‚’ç›£è¦–
- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§å¯è¦–åŒ–

**B. ã‚¨ãƒ©ãƒ¼è¿½è·¡ï¼ˆSentryï¼‰**
```typescript
// src/lib/monitoring.ts
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1, // 10%ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒˆãƒ¬ãƒ¼ã‚¹
});

// ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«è‡ªå‹•é€ä¿¡
export function captureError(error: Error, context?: Record<string, unknown>) {
  Sentry.captureException(error, { extra: context });
}
```

**C. ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š**
- APIã‚¨ãƒ©ãƒ¼ç‡ > 1% â†’ Slacké€šçŸ¥
- P95ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· > 500ms â†’ Slacké€šçŸ¥
- æ±ºæ¸ˆå¤±æ•—ç‡ > 2% â†’ é›»è©±ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

---

#### 8. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®å°å…¥

**ææ¡ˆ**:
```typescript
// src/lib/cache.ts
import { Redis } from '@upstash/redis';

const redis = new Redis({
  url: process.env.UPSTASH_REDIS_URL!,
  token: process.env.UPSTASH_REDIS_TOKEN!,
});

export async function getCached<T>(
  key: string,
  fetcher: () => Promise<T>,
  ttl: number = 300 // 5åˆ†
): Promise<T> {
  const cached = await redis.get<T>(key);
  if (cached) return cached;

  const data = await fetcher();
  await redis.setex(key, ttl, data);
  return data;
}

// ä½¿ç”¨ä¾‹: åº—èˆ—æƒ…å ±ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
const store = await getCached(
  `store:${storeId}`,
  () => fetchStore(storeId),
  600 // 10åˆ†
);
```

**ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾è±¡**:
- åº—èˆ—æƒ…å ±ï¼ˆå¤‰æ›´é »åº¦ãŒä½ã„ï¼‰
- ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§
- å–¶æ¥­æ™‚é–“è¨­å®š

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„

### 1. ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ˜ç¢ºåŒ–

**ç¾çŠ¶**: ãƒ­ã‚¸ãƒƒã‚¯ãŒAPIãƒ«ãƒ¼ãƒˆã«ç›´æ¥è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ç®‡æ‰€ãŒã‚ã‚‹

**ææ¡ˆ**:
```
src/
â”œâ”€â”€ app/                    # Next.js App Routerï¼ˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ã¿ï¼‰
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ bookings/
â”‚           â””â”€â”€ route.ts   # ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å¤‰æ›ã®ã¿
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ api/               # APIå±¤ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
â”‚   â”‚   â””â”€â”€ bookings/
â”‚   â”‚       â””â”€â”€ service.ts
â”‚   â”œâ”€â”€ domain/            # ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â””â”€â”€ booking/
â”‚   â”‚       â””â”€â”€ booking.ts
â”‚   â””â”€â”€ infrastructure/    # ã‚¤ãƒ³ãƒ•ãƒ©å±¤ï¼ˆDBã€å¤–éƒ¨APIï¼‰
â”‚       â””â”€â”€ repositories/
â”‚           â””â”€â”€ booking-repository.ts
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ã®å‘ä¸Š
- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®å†åˆ©ç”¨
- ä¾å­˜é–¢ä¿‚ã®æ˜ç¢ºåŒ–

---

### 2. ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å°å…¥ï¼ˆå°†æ¥ï¼‰

**Phase 2ä»¥é™ã®ææ¡ˆ**:
```typescript
// src/lib/events/event-bus.ts
export interface DomainEvent {
  type: string;
  payload: unknown;
  timestamp: Date;
  userId?: string;
}

export class EventBus {
  async publish(event: DomainEvent) {
    // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
    // - é€šçŸ¥é€ä¿¡
    // - åˆ†æãƒ‡ãƒ¼ã‚¿ã®è¨˜éŒ²
    // - å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã¸ã®é€£æº
  }
}

// ä½¿ç”¨ä¾‹
eventBus.publish({
  type: 'booking.created',
  payload: { bookingId: booking.id, storeId: store.id },
  timestamp: new Date(),
});
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ç–çµåˆãªè¨­è¨ˆ
- æ‹¡å¼µæ€§ã®å‘ä¸Š
- éåŒæœŸå‡¦ç†ã®å®¹æ˜“åŒ–

---

## é‹ç”¨ãƒ»ç›£è¦–ã®å¼·åŒ–

### 1. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

**ææ¡ˆ**:
```typescript
// src/app/api/health/route.ts
export async function GET() {
  const checks = {
    database: await checkDatabase(),
    stripe: await checkStripe(),
    line: await checkLine(),
  };

  const isHealthy = Object.values(checks).every((c) => c.status === 'ok');

  return NextResponse.json(
    {
      status: isHealthy ? 'healthy' : 'degraded',
      checks,
      timestamp: new Date().toISOString(),
    },
    { status: isHealthy ? 200 : 503 }
  );
}
```

---

### 2. ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†

**ææ¡ˆ**:
```typescript
// src/lib/metrics.ts
export const metrics = {
  bookingCreated: new Counter('bookings_created_total'),
  bookingDuration: new Histogram('booking_duration_seconds'),
  apiLatency: new Histogram('api_request_duration_seconds'),
};

// ä½¿ç”¨ä¾‹
metrics.bookingCreated.inc({ store_id: store.id });
```

---

## ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### ãƒ†ã‚¹ãƒˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰

```
        /\
       /  \      E2E (10%)
      /____\
     /      \    Integration (20%)
    /________\
   /          \  Unit (70%)
  /____________\
```

**å„ªå…ˆé †ä½**:
1. **ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ`src/lib/booking-logic.ts`ç­‰ï¼‰
2. **çµ±åˆãƒ†ã‚¹ãƒˆ**: APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
3. **E2Eãƒ†ã‚¹ãƒˆ**: ä¸»è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ï¼ˆäºˆç´„ä½œæˆã€ç®¡ç†ç”»é¢æ“ä½œï¼‰

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã®æœ€é©åŒ–

### 1. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥ã®æ–‡æ›¸åŒ–

**ææ¡ˆ**:
```sql
-- supabase/migrations/20241225_indexes_documentation.sql

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ç›®çš„ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§æ˜è¨˜
-- Index: idx_bookings_org_store_date
-- Purpose: åº—èˆ—åˆ¥ã®äºˆç´„ä¸€è¦§å–å¾—ã‚’é«˜é€ŸåŒ–
-- Query Pattern: SELECT * FROM bookings WHERE organization_id = ? AND store_id = ? AND start_time >= ?
CREATE INDEX IF NOT EXISTS idx_bookings_org_store_date 
ON bookings(organization_id, store_id, start_time DESC);
```

---

### 2. ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°æ¤œè¨ï¼ˆå°†æ¥ï¼‰

**å¤§é‡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ**:
```sql
-- äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æœˆå˜ä½ã§ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³åˆ†å‰²
CREATE TABLE bookings_2024_12 PARTITION OF bookings
FOR VALUES FROM ('2024-12-01') TO ('2025-01-01');
```

---

## ã‚³ãƒ¼ãƒ‰å“è³ªã®å‘ä¸Š

### 1. ESLintãƒ«ãƒ¼ãƒ«ã®å¼·åŒ–

**ææ¡ˆ**:
```javascript
// eslint.config.mjs
export default {
  rules: {
    '@typescript-eslint/no-explicit-any': 'error',
    '@typescript-eslint/explicit-function-return-type': 'warn',
    'no-console': ['warn', { allow: ['warn', 'error'] }],
  },
};
```

---

### 2. Pre-commitãƒ•ãƒƒã‚¯

**ææ¡ˆ**:
```json
// package.json
{
  "scripts": {
    "pre-commit": "lint-staged"
  },
  "lint-staged": {
    "*.{ts,tsx}": ["eslint --fix", "prettier --write"],
    "*.{sql}": ["prettier --write"]
  }
}
```

---

## å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase 1ï¼ˆ1ãƒ¶æœˆï¼‰
- [ ] æ§‹é€ åŒ–ãƒ­ã‚°ã®å°å…¥
- [ ] ç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼
- [ ] APIãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®çµ±ä¸€

### Phase 2ï¼ˆ3ãƒ¶æœˆï¼‰
- [ ] ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã®ç¢ºç«‹ï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸50%ä»¥ä¸Šï¼‰
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã®æ”¹å–„
- [ ] APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹ã®çµ±ä¸€

### Phase 3ï¼ˆ6ãƒ¶æœˆï¼‰
- [ ] ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆã®å®Ÿè£…
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®å°å…¥
- [ ] ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ˜ç¢ºåŒ–

---

## ã¾ã¨ã‚

Amberãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯æ—¢ã«è‰¯ã„åŸºç›¤ã‚’æŒã£ã¦ã„ã¾ã™ãŒã€ä»¥ä¸‹ã®æ”¹å–„ã«ã‚ˆã‚Šã€**æ‹¡å¼µæ€§ã¨ä¿å®ˆæ€§ãŒå¤§å¹…ã«å‘ä¸Š**ã—ã¾ã™ï¼š

1. **å³åº§ã«å¯¾å¿œ**: ãƒ­ã‚°ã€ç’°å¢ƒå¤‰æ•°æ¤œè¨¼ã€APIãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
2. **çŸ­æœŸå¯¾å¿œ**: ãƒ†ã‚¹ãƒˆã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã€å‹å®‰å…¨æ€§
3. **é•·æœŸå¯¾å¿œ**: ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„

ã“ã‚Œã‚‰ã®æ”¹å–„ã«ã‚ˆã‚Šã€**Phase 2ä»¥é™ã®æ©Ÿèƒ½è¿½åŠ ãŒå®¹æ˜“**ã«ãªã‚Šã€**æœ¬ç•ªç’°å¢ƒã§ã®é‹ç”¨ãŒå®‰å®š**ã—ã¾ã™ã€‚

---

## å‚è€ƒè³‡æ–™

- [PRD Section 18: éæ©Ÿèƒ½è¦ä»¶](docs/prd.md#18-éæ©Ÿèƒ½è¦ä»¶non-functional-requirements)
- [PRD Section 17: ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ä½“ç³»](docs/prd.md#17-ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ä½“ç³»error-code-taxonomy)
- [DEVELOPMENT.md](DEVELOPMENT.md)



