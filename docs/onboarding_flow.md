# 新規事業者オンボーディングフロー

本ドキュメントでは、Amber プラットフォームに新規登録する事業者が、初期設定から実際の予約受付開始までに必要なステップを詳しく説明します。

---

## 概要

Amber はマルチテナント構造を採用しており、**フランチャイズ本部（Super Admin / Org Admin）** と **店舗管理者（Store Admin）** では、オンボーディングフローが異なります。

### 役割の違い

- **フランチャイズ本部 / 経営者（Super Admin / Org Admin）**: 組織全体のオーナーとして、インフラと決済基盤を構築し、複数店舗を統括管理
- **店舗管理者 / 店長（Store Admin）**: 特定の店舗の責任者として、現場の稼働環境を整え、日々の予約管理を行う

---

## 1. フランチャイズ本部 / 経営者（Super Admin）のオンボーディング

組織全体のオーナーとして、以下の順序で設定を進めます。

### ステップ1: アカウント作成 / 組織登録

1. **ログインページ** (`/login`) にアクセス
2. **新規登録**（現在は手動でアカウント作成が必要）
   - Email と Password を設定
   - Supabase Auth でアカウント作成
3. **組織（Organization）の作成**
   - 初回ログイン時に組織情報を入力
   - 組織名、スラッグ（URL用）を設定
   - `organizations` テーブルにレコード作成
   - 作成者の `profiles` に `role = 'org_admin'` を設定

> [!NOTE]
> **現在の実装状況**: 
> - ログインページは実装済み (`src/app/login/page.tsx`)
> - 組織作成のUIは未実装（手動でデータベースに作成するか、API経由で作成が必要）

### ステップ2: Stripe Connect 連携（決済基盤構築）

1. **管理画面** (`/admin`) にアクセス
2. **設定ページ** (`/admin/settings`) で Stripe Connect 連携を開始
3. **Stripe Connect オンボーディング**
   - `/api/stripe/connect/onboard` エンドポイントを呼び出し
   - Stripe Connect アカウントを作成（`type: 'standard'`）
   - `organizations.stripe_account_id` に保存
   - Stripe のオンボーディングページにリダイレクト
   - 事業者情報（法人名、住所、銀行口座等）を入力
   - 審査完了後、決済受付が可能に

> [!NOTE]
> **現在の実装状況**: 
> - Stripe Connect オンボーディングAPIは実装済み (`src/app/api/stripe/connect/onboard/route.ts`)
> - UIからの呼び出しは未実装の可能性あり

### ステップ3: プラン選択 / 機能権限設定

1. **プラン選択**
   - Starter（¥0/月）、Growth（¥9,800/月）、Enterprise（個別見積もり）から選択
   - `organizations.plan_type` に保存
   - プランに応じた制限（店舗数、スタッフ数、家カルテ数）が適用

2. **機能権限の確認**
   - プランに応じて利用可能な機能が自動的に有効化
   - 未契約機能には「Proプラン」ラベルが表示

> [!NOTE]
> **現在の実装状況**: 
> - プラン管理のマイグレーションは実装済み (`supabase/migrations/20241221_phase1_3_pricing_plans.sql`)
> - プラン選択UIは未実装の可能性あり

### ステップ4: 店舗（Stores）の作成

1. **店舗管理ページ** (`/admin/stores`) にアクセス
2. **新規店舗作成**
   - 店舗名、スラッグ（URL用）、住所、電話番号、メールアドレスを入力
   - `/api/stores` (POST) で店舗を作成
   - プラン制限（店舗数上限）をチェック
   - `stores` テーブルにレコード作成

3. **営業時間の設定**（オプション）
   - デフォルト: 月〜土 9:00-18:00、日曜休業
   - `stores.business_hours` (JSONB) に保存

> [!NOTE]
> **現在の実装状況**: 
> - 店舗作成APIは実装済み (`src/app/api/stores/route.ts`)
> - 店舗管理ページは実装済み (`src/app/admin/stores/page.tsx`)

### ステップ5: 店舗管理者の招待 / 権限付与

1. **スタッフ管理ページ** (`/admin/staff`) にアクセス
2. **店舗管理者の追加**
   - Email で招待（または既存ユーザーに権限付与）
   - `profiles` テーブルに `role = 'store_manager'` を設定
   - `profiles_stores` テーブルで店舗との紐付け
   - 招待メール送信（未実装の可能性あり）

> [!NOTE]
> **現在の実装状況**: 
> - スタッフ管理ページは実装済み (`src/app/admin/staff/page.tsx`)
> - スタッフ作成APIは実装済み (`src/app/api/staff/route.ts`)

### ステップ6: 全店舗のパフォーマンス監視開始

1. **本部ダッシュボード** (`/hq`) にアクセス
2. **全店舗の売上・予約状況を監視**
   - 各店舗の売上、予約数、成約率などを一覧表示
   - 分析ダッシュボードで詳細を確認

> [!NOTE]
> **現在の実装状況**: 
> - 本部ダッシュボードは実装済み (`src/app/hq/page.tsx`)
> - 分析APIは実装済み (`src/app/api/hq/analytics/route.ts`)

---

## 2. 店舗管理者 / 店長（Store Admin）のオンボーディング

特定の店舗の責任者として、以下の順序で設定を進めます。

### ステップ1: 招待承諾 / ログイン

1. **招待メール**（または本部からの案内）を受け取る
2. **ログインページ** (`/login`) にアクセス
3. **ログイン**
   - Email と Password でログイン
   - 初回ログイン時はパスワード設定が必要（未実装の可能性あり）

> [!NOTE]
> **現在の実装状況**: 
> - ログインページは実装済み
> - 招待メール送信機能は未実装の可能性あり

### ステップ2: 店舗プロフィール設定（営業時間・住所）

1. **店舗設定ページ** (`/admin/stores/[id]`) にアクセス
2. **基本情報の確認・編集**
   - 店舗名、住所、電話番号、メールアドレス
   - 営業時間の設定（`business_hours` JSONB）
   - 最大同時対応数（`max_capacity`）の設定

3. **保存**
   - `/api/stores/[id]` (PUT) で更新

> [!NOTE]
> **現在の実装状況**: 
> - 店舗詳細ページは実装済み (`src/app/admin/stores/[id]/page.tsx`)
   - 店舗更新APIは実装済み (`src/app/api/stores/[id]/route.ts`)

### ステップ3: サービス・オプションのカスタマイズ

1. **サービス管理ページ** (`/admin/services`) にアクセス
2. **サービスの追加**
   - サービス名（`title`）、価格（`price`）、所要時間（`duration_minutes`）、説明（`description`）を入力
   - `/api/services` (POST) でサービスを作成
   - 画像URL（`image_url`）を設定（オプション）

3. **オプションの追加**（オプション）
   - 各サービスにオプション（追加料金、追加時間）を設定
   - `/api/services/options` (POST) でオプションを作成

> [!NOTE]
> **現在の実装状況**: 
> - サービス管理ページは実装済み (`src/app/admin/services/page.tsx`)
> - サービス作成APIは実装済み (`src/app/api/services/route.ts`)

### ステップ4: 所属スタッフ登録 & シフト設定

1. **スタッフ管理ページ** (`/admin/staff`) にアクセス
2. **スタッフの追加**
   - スタッフ名、アバターURL（オプション）を入力
   - `/api/staff` (POST) でスタッフを作成
   - 指名料（`nomination_fee`）を設定（オプション）

3. **シフト設定**（将来実装予定）
   - 各スタッフの稼働日・時間を設定
   - `shifts` テーブルに保存

> [!NOTE]
> **現在の実装状況**: 
> - スタッフ管理ページは実装済み (`src/app/admin/staff/page.tsx`)
> - スタッフ作成APIは実装済み (`src/app/api/staff/route.ts`)
> - シフト設定機能は未実装（Phase 1.1ではキャパシティベースの管理）

### ステップ5: 店舗専用予約URL / LINE連携の公開

1. **店舗設定ページ** (`/admin/stores/[id]`) で予約URLを確認
   - 予約URL: `/book/{org_slug}/{store_slug}`
   - またはルート (`/`) で最初の店舗を自動表示

2. **LINE連携**（Growthプラン以上）
   - LINE公式アカウントと連携
   - Webhook URLを設定
   - リッチメニューに予約リンクを追加

3. **ブランディング設定**（オプション）
   - 店舗ロゴ、メインカラー、ウェルカムメッセージを設定
   - `/admin/stores/[id]/branding` で設定

> [!NOTE]
> **現在の実装状況**: 
> - 予約ページは実装済み (`src/app/page.tsx`, `src/app/book/[org_slug]/[store_slug]/page.tsx`)
> - LINE連携APIは実装済み (`src/app/api/line/webhook/route.ts`)
> - ブランディング設定ページは実装済み (`src/app/admin/stores/[id]/branding/page.tsx`)

### ステップ6: 日々の予約管理・現場指示開始

1. **予約一覧ページ** (`/admin/bookings`) で予約を確認
2. **カレンダーページ** (`/admin/calendar`) でスケジュールを確認
3. **予約の承認・調整**
   - 予約ステータスの更新（`pending` → `confirmed`）
   - スタッフのアサイン
   - 顧客への通知送信

> [!NOTE]
> **現在の実装状況**: 
> - 予約一覧ページは実装済み (`src/app/admin/bookings/page.tsx`)
> - カレンダーページは実装済み (`src/app/admin/calendar/page.tsx`)

---

## 3. 個人店 / 単一店舗事業者のオンボーディング

個人店や単一店舗事業者の場合、**フランチャイズ本部**と**店舗管理者**の役割を同一人物が兼任します。

### 簡略化されたフロー

1. **アカウント作成 / 組織登録**（ステップ1）
2. **Stripe Connect 連携**（ステップ2）
3. **プラン選択**（Starterプラン推奨）
4. **店舗作成**（1店舗のみ）
5. **サービス・スタッフ登録**（ステップ3-4）
6. **予約URL公開**（ステップ5）
7. **予約管理開始**（ステップ6）

---

## 4. 現在の実装状況と不足している機能

### 実装済み

- ✅ ログイン機能
- ✅ 店舗作成・管理
- ✅ サービス管理
- ✅ スタッフ管理
- ✅ 予約管理
- ✅ Stripe Connect オンボーディングAPI
- ✅ プラン管理（データベース層）

### 未実装 / 改善が必要

- ❌ **新規登録（サインアップ）UI**
  - 現在は手動でアカウント作成が必要
  - 組織作成のUIがない

- ❌ **オンボーディングウィザード**
  - 初回ログイン時に設定を案内するウィザードがない
  - ステップバイステップのガイドがない

- ❌ **プラン選択UI**
  - プラン選択・変更のUIがない
  - プラン制限の表示がない

- ❌ **招待メール送信**
  - 店舗管理者への招待メール送信機能がない

- ❌ **初期データの自動生成**
  - デモサービス・スタッフの自動生成がない（開発用のシード機能はある）

---

## 5. 推奨される改善案

### 短期（Phase 1.1）

1. **新規登録ページの実装**
   - `/signup` ページを作成
   - 組織情報入力フォーム
   - 初回ユーザーを `org_admin` として自動設定

2. **オンボーディングチェックリスト**
   - 初回ログイン時に未完了の設定を表示
   - 各設定ページへのリンクを提供

### 中期（Phase 1.2）

1. **オンボーディングウィザード**
   - ステップバイステップの設定ガイド
   - 進捗状況の保存

2. **プラン選択UI**
   - プラン比較ページ
   - プラン変更機能

3. **招待機能**
   - 店舗管理者への招待メール送信
   - 招待リンクの生成

---

## 6. 参考資料

- [ユーザージャーニー（User Journey）](./user_journey.md)
- [PRD - マルチテナント管理](./prd.md#4-3-マルチテナント管理multi-tenancy)
- [PRD - 料金プラン](./prd.md#6-料金プラン--機能制限pricing-plans--limits)














